

### Application Load Balancer (v2)

- Application load balancers is Layer 7 (HTTP)
- Load balancing to multiple HTTP applications across machines (target groups)
- Load balancing to multiple applications on the same machine (ex: containers)
- Support for HTTP/2 and WebSocket 
- Support redirects (from HTTP to HTTPS for example)


- Routing tables to different target groups 
	- Routing based on path in URL 
	- Routing based on hostname in URL
	- Routing based on Query String, Headers 

- ALB are a great fit for micro services & container-based application 
- Has a port mapping feature to redirect to a dynamic port in ECS
- In comparison, we'd need multiple Classic Load Balancer per application 


**Target Groups** 

- EC2 instances (can be managed by an Auto Scaling Group) - HTTP 
- ECS tasks 
- Lambda functions 
- IP Addresses - must be private IPs 

- ALB can route to multiple target groups 
- Health checks are at the target group level 

- Fixed hostname (XXX.region.elb.amazonaws.com)
- The application servers don't see the IP of the client directly 
	- The true IP of the client is inserted in the header X-Forwarded-For 
- We can also get Port and proto 


```
#!/bin/bash
# Use this for your user data (script from top to bottom)
# install httpd (Linux 2 version)
yum update -y 
yum install -y httpd
systemctl start httpd
systemctl enable httpd
echo "<h1>Hello World from $(hostname -f)</h1>" > /var/www/html/index.html
```


---

### Network Load Balancer (v2)

- Network load balancers (Layer 4) allow to :
	- Forward TCP & UDP traffic to your instances 
	- Handle millions of request per seconds 
	- Ultra-low latency 

- NLB has one static IP per AZ, and supports assigning Elastic IP (helpful for whitelisting specific IP)


**Target Groups**
- EC2 instances 
- IP Addresses - must be private IPS 
- Application Load Balancer 
- Health Checks support the TCP,HTTP and HTTPS Protocols 

---

### Gateway Load Balancer 

- Deploy, scale, and manage a fleet of 3rd party 
network virtual appliances in AWS 
- Example: Firewalls, Intrusion Detection and Prevention Systems, Deep Packet Inspection Systems, payload manipulation 

- Operates at Layer 3 (Network Layer) - IP Packets
- Combines the following functions : 
	- **Transparent Network Gateway** - single entry/exit for all traffic 
	- Load Balancer - distributes traffic to your virtual appliances 
- Uses the **GENEVE** protocol port **6081** 


Gateway Load Balancer - Target Groups 

- EC2 instances 
- IP Addresses - must be private IPs 

---

### Sticky Session (Session Affinity )

- It is possible to implement stickiness so that the same client is always redirected to the same instance behind a load balancer 
- This works for **Classic Load Balancer, Application Load Balancer, and Network Load Balancer** 
- The "cookie" use for stickiness has an expiration date you control 
- Use case: make sure the user doesn't lose his session data 
- Enabling stickiness may bring imbalance to the load over the backend EC2 instances 

### Sticky Session - Cookie Names 

- Application-based Cookies 
	- Custom cookie 
		- Generated by the target 
		- Can include any custom attributes required by the application 
		- Cookie name must be specified individually for each target group
		- Don't use AWSALB, AWSALBAPp, or AWSALBTG (reserved for use by the ELB)
	- Application cookie 
		- Generated by the load balancer 
		- Cookie name is AWSALBAPP 
- Duration-based Cookies 
	- Cookie generated by the load balancer 
	- Cookie name is AWSALB for ALB, AWSELB for CLB